function JAtom(A){this._parse(A)}JAtom.prototype={_parse:function(A){var C=AJS.$("feed",A).eq(0);var B=this;this.version="1.0";this.title=AJS.$(C).find("title:first").text();this.link=AJS.$(C).find("link:first").attr("href");this.description=AJS.$(C).find("subtitle:first").text();this.language=AJS.$(C).attr("xml:lang");this.updated=AJS.$(C).find("updated:first").text();this.items=new Array();var D=this;AJS.$("entry",A).each(function(){var E=new JFeedItem();E.title=AJS.$(this).find("title").eq(0).text();AJS.$(this).find("link").each(function(){var F=AJS.$(this).attr("rel");var G=AJS.$(this).attr("href");if(F=="alternate"){E.link=G}else{if(F=="http://streams.atlassian.com/syndication/reply-to"){E.replyTo=G}else{if(F=="http://streams.atlassian.com/syndication/icon"){E.icon=G}}}});E.summary=AJS.$(this).find("summary").eq(0).text();E.updated=AJS.$(this).find("updated").eq(0).text();E.id=AJS.$(this).find("id").eq(0).text();E.category=AJS.$(this).find("category:first").attr("term");AJS.$(this).find("author").each(function(){E.authors.push(B._parsePerson(this))});D.items.push(E)})},_parsePerson:function(B){var A=new JFeedPerson();A.name=AJS.$(B).find("name").eq(0).text();A.email=AJS.$(B).find("email").eq(0).text();A.uri=AJS.$(B).find("uri").eq(0).text();A.username=AJS.$(B).find("username").eq(0).text();return A},_getContentValue:function(C,A){var B=C.find(A+":first");if(B){return B.text()}else{return""}}};function JFeedItem(){this.authors=new Array()}JFeedItem.prototype={title:"",link:"",summary:"",updated:"",id:"",category:"",inReplyTo:"",replyTo:"",icon:""};function JFeedPerson(){}JFeedPerson.prototype={name:"",email:"",uri:"",username:""};function ActivityFeed(B,D,A){this.feedId=B;this.feedUrl=D;this.maxResults=parseInt(A);var C=this;C.gadgetPrefs=new gadgets.Prefs();this.COMMENT_ICON_HTML='<a class="activity-item-comment-icon" style="visibility:hidden" href="#" title="'+C.gadgetPrefs.getMsg("gadget.activity.stream.add.comment")+'">&nbsp;</a>'}ActivityFeed.prototype.setFeedUrl=function(A){this.feedUrl=A};ActivityFeed.prototype.addItem=function(D,A){var F=Date.parseExact(D.updated,"yyyy-MM-ddTHH:mm:ssZ").setTimezone("UTC").set({minute:0});var C=this.getOrCreateDateContainer(F.toString(A.container),F.toString(A.pretty));var B=C.children("ul");var E=AJS.$(document.createElement("li"));E.addClass("activity-item");if(D.icon){E.css("backgroundImage","url('"+D.icon+"')")}E.html(D.summary);B.append(E)};ActivityFeed.prototype.getOrCreateDateContainer=function(F,E){var C="dateContainer-"+this.feedId+"-"+F;var B=AJS.$("#"+C);if(B.size()==0){var G=AJS.$("#feedContainer-"+this.feedId);B=AJS.$(document.createElement("div"));B.attr("id",C);G.append(B);var A=AJS.$(document.createElement("h3"));A.addClass("timestamp");A.html(E);B.append(A);var D=AJS.$(document.createElement("ul"));D.addClass("activityItems");B.append(D)}return B};ActivityFeed.prototype.getDateFormat=function(A,B){if(A==null||B==null){return{container:"yyyyMMddHH",pretty:Date.CultureInfo.formatPatterns.monthDay+" - "+Date.CultureInfo.formatPatterns.shortTime}}var D=B.getTime()-A.getTime();var C=1000*60*60*24;if(D<=C*2){return{container:"yyyyMMddHH",pretty:Date.CultureInfo.formatPatterns.monthDay+" - "+Date.CultureInfo.formatPatterns.shortTime}}else{if(D<=C*30){return{container:"yyyyMMdd",pretty:Date.CultureInfo.formatPatterns.monthDay}}else{return{container:"yyyyMM",pretty:Date.CultureInfo.formatPatterns.yearMonth}}}};ActivityFeed.prototype.addCommentForms=function(D){var B=this;for(var A=0;A<D.items.length;A++){var C=D.items[A];if(C.replyTo){C.summary=this.COMMENT_ICON_HTML+C.summary+'<form method="POST" class="activity-item-comment-form"><fieldset><input type="hidden" name="replyTo" value="'+C.replyTo+'"/><textarea name="comment" rows="6" cols="40"></textarea><button type="submit" name="submit">'+B.gadgetPrefs.getMsg("gadget.activity.stream.save")+"</button></fieldset></form>"}}};ActivityFeed.prototype.populateFeed=function(){var C=this;var A=function(I,G){var K="feedContainer-"+C.feedId;var M=new JAtom(I);if(!M||!M.items||M.items.length==0){C.setDivText(K,C.gadgetPrefs.getMsg("gadget.activity.stream.no.activty.found"));AJS.$("#showMoreLink-"+C.feedId).hide();C.feedPopulated();return }C.setDivText(K,"");C.setError(null);C.setWarning(null);C.addCommentForms(M);var F,H;for(var J=0;J<M.items.length;J++){var L=Date.parse(M.items[J].updated);if(J==0){F=L;H=L}else{if(L.getTime()>F.getTime()){F=L}else{if(L.getTime()<H.getTime()){H=L}}}}var E=C.getDateFormat(H,F);for(J=0;J<M.items.length;J++){C.addItem(M.items[J],E)}if(M.items.length<C.maxResults){AJS.$("#showMoreLink-"+C.feedId).hide()}AJS.$(".activity-item:has(.activity-item-comment-icon)").hover(function(){AJS.$(this).children(".activity-item-comment-icon").css("visibility","visible").fadeIn("fast")},function(){AJS.$(this).children(".activity-item-comment-icon").fadeOut("fast",function(){AJS.$(this).css("visibility","hidden").css("display","inline")})});AJS.$(".activity-item").hover(function(){AJS.$(this).addClass("hover")},function(){AJS.$(this).removeClass("hover")});AJS.$(".activity-item-comment-icon").click(function(N){N.preventDefault();AJS.$(this).parent().children("form.activity-item-comment-form").slideToggle(function(){C.feedResized()})}).toggle(function(){AJS.$(this).addClass("hide").attr("title",C.gadgetPrefs.getMsg("gadget.activity.stream.hide"))},function(){AJS.$(this).removeClass("hide").attr("title",C.gadgetPrefs.getMsg("gadget.activity.stream.add.comment"))});AJS.$(".activity-item-comment-form").children().focus(function(){AJS.$(this).parent().children("button").attr("accesskey","s")}).blur(function(){AJS.$(this).parent().children("button").removeAttr("accesskey")});AJS.$(".activity-item-comment-form").submit(function(O){O.preventDefault();var N=AJS.$(this);var P=AJS.$.trim(N.find("textarea").val());if(P.length===0){alert(C.gadgetPrefs.getMsg("gadget.activity.stream.error.add.comment"));return }N.children("button").attr("disabled","true");AJS.$.post("/plugins/servlet/streamscomments",AJS.$(this).serialize(),function(){N.children("textarea").val("").end();N.prev(".activity-item-comment-icon").click();N.children("button").attr("disabled","false");C.populateFeed()},"text")});C.feedPopulated()};var B=function(E,G,F){C.setDivText("feedContainer-"+C.feedId,"");C.setError("Error communicating with server: "+E.statusText);AJS.$("#showMoreLink-"+C.feedId).hide();C.feedPopulated()};var D=this.feedUrl;if(D.indexOf("?")<0){D+="?"}else{D+="&"}D+="maxResults="+this.maxResults;this.issueRequest("GET",D,null,A,B)};ActivityFeed.prototype.issueRequest=function(E,B,C,A,D){AJS.$.ajax({type:E,url:B,dataType:"xml",success:A,error:D})};ActivityFeed.prototype.feedPopulated=function(){};ActivityFeed.prototype.feedResized=function(){};ActivityFeed.prototype.setWarning=function(A){this.setMessage("#feedWarning-"+this.feedId,A)};ActivityFeed.prototype.setError=function(A){this.setMessage("#feedError-"+this.feedId,A)};ActivityFeed.prototype.setMessage=function(C,A){var B=AJS.$(C);B.text(A);A?B.show():B.hide()};ActivityFeed.prototype.setDivText=function(A,B){var C=document.getElementById(A);if(C){C.innerHTML=B?'<div class="inner">'+B+"</div>":""}else{alert(B)}};ActivityFeed.toggleStackTraces=function(){AJS.$(".activityFeed .stream-error .stack-trace").toggle()};function isNumeric(B){var D="0123456789";var A;for(var C=0;C<B.length;C++){A=B.charAt(C);if(D.indexOf(A)==-1){return false}}return true}function htmlEncode(A){return AJS.$("<div/>").text(A).html()};
